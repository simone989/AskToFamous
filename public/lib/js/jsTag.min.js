"use strict";function getNumberOfProperties(a){return Object.keys(a).length}function getFirstProperty(a){var b=Object.keys(a);return a[b[0]]}function getLastProperty(a){var b=Object.keys(a);return a[b[b.length-1]]}function getNextProperty(a,b){var c=Object.keys(a),d=c.indexOf(b.toString()),e=c[d+1];return a[e]}function getPreviousProperty(a,b){var c=Object.keys(a),d=c.indexOf(b.toString()),e=c[d-1];return a[e]}var jsTag=angular.module("jsTag",[]);jsTag.constant("jsTagDefaults",{edit:!0,defaultTags:[],breakCodes:[13,44],splitter:",",texts:{inputPlaceHolder:"Input text",removeSymbol:String.fromCharCode(215)}});var jsTag=angular.module("jsTag");jsTag.filter("inArray",function(){return function(a,b){for(var c in b)if(a===b[c])return!0;return!1}}),jsTag.filter("toArray",function(){return function(a){var b=[];for(var c in a){var d=a[c];b.push(d)}return b}});var jsTag=angular.module("jsTag");jsTag.factory("JSTag",function(){function a(a,b){this.value=a,this.id=b}return a});var jsTag=angular.module("jsTag");jsTag.factory("JSTagsCollection",["JSTag","$filter",function(a,b){function c(a){this.tags={},this.tagsCounter=0;for(var b in a){var c=a[b];this.addTag(c)}this._onAddListenerList=[],this._onRemoveListenerList=[],this.unsetActiveTags(),this.unsetEditedTag(),this._valueFormatter=null,this._valueValidator=null}return c.prototype.setValueValidator=function(a){this._valueValidator=a},c.prototype.setValueFormatter=function(a){this._valueFormatter=a},c.prototype.addTag=function(b){var c=this.tagsCounter;this.tagsCounter++;var d=new a(b,c);this.tags[c]=d,angular.forEach(this._onAddListenerList,function(a){a(d)})},c.prototype.removeTag=function(a){var b=this.tags[a];delete this.tags[a],angular.forEach(this._onRemoveListenerList,function(a){a(b)})},c.prototype.onAdd=function(a){this._onAddListenerList.push(a)},c.prototype.onRemove=function(a){this._onRemoveListenerList.push(a)},c.prototype.getNumberOfTags=function(){return getNumberOfProperties(this.tags)},c.prototype.getTagValues=function(){var a=[];for(var b in this.tags)a.push(this.tags[b].value);return a},c.prototype.getPreviousTag=function(a){var b=getFirstProperty(this.tags);return b.id===a.id?a:getPreviousProperty(this.tags,a.id)},c.prototype.getNextTag=function(a){var b=getLastProperty(this.tags);return a.id===b.id?a:getNextProperty(this.tags,a.id)},c.prototype.isTagActive=function(a){return b("inArray")(a,this._activeTags)},c.prototype.setActiveTag=function(a){this.isTagActive(a)||this._activeTags.push(a)},c.prototype.setLastTagActive=function(){if(getNumberOfProperties(this.tags)>0){var a=getLastProperty(this.tags);this.setActiveTag(a)}},c.prototype.unsetActiveTag=function(a){this._activeTags.splice(this._activeTags.indexOf(a),1)},c.prototype.unsetActiveTags=function(){this._activeTags=[]},c.prototype.getActiveTag=function(){var a=null;return 1===this._activeTags.length&&(a=this._activeTags[0]),a},c.prototype.getNumOfActiveTags=function(){return this._activeTags.length},c.prototype.getEditedTag=function(){return this._editedTag},c.prototype.isTagEdited=function(a){return a===this._editedTag},c.prototype.setEditedTag=function(a){this._editedTag=a},c.prototype.unsetEditedTag=function(){void 0!==this._editedTag&&null!==this._editedTag&&""===this._editedTag.value&&this.removeTag(this._editedTag.id),this._editedTag=null},c}]);var jsTag=angular.module("jsTag");jsTag.factory("InputService",["$filter",function(a){function b(a){this.input="",this.isWaitingForInput=a.autoFocus||!1,this.options=a}return b.prototype.onKeydown=function(b,c,d){var e=d.$event,f=angular.element(e.currentTarget),g=e.which,h=this.input||(void 0!==f.typeahead?f.typeahead("val"):void 0),i=null===h||void 0===h||""===h;if(a("inArray")(g,this.options.breakCodes)!==!1)b.breakCodeHit(c,this.options),f.triggerHandler("jsTag:breakcodeHit"),i||e.preventDefault();else switch(g){case 9:break;case 37:case 8:i&&c.setLastTagActive()}},b.prototype.tagInputKeydown=function(b,c){var d=c.$event,e=d.which;a("inArray")(e,this.options.breakCodes)!==!1&&this.breakCodeHitOnEdit(b,c)},b.prototype.onBlur=function(a){this.breakCodeHit(a,this.options)},b.prototype.resetInput=function(){var a=this.input;return this.input="",a},b.prototype.focusInput=function(){this.isWaitingForInput=!0},b.prototype.breakCodeHit=function(a,b){if(""!==this.input){if(a._valueFormatter&&(this.input=a._valueFormatter(this.input)),a._valueValidator&&!a._valueValidator(this.input))return;var c=this.resetInput();c instanceof Object&&(c=c[b.tagDisplayKey||Object.keys(c)[0]]);for(var d=c.split(b.splitter),e=0;e<d.length;e++)d[e]||(d.splice(e,1),e--);for(var f in d)if(d.hasOwnProperty(f)){var g=d[f];a.addTag(g)}}},b.prototype.breakCodeHitOnEdit=function(a,b){var c=a.getEditedTag();c.value instanceof Object&&(c.value=c.value[b.tagDisplayKey||Object.keys(c.value)[0]]),a.unsetEditedTag(),this.isWaitingForInput=!0},b}]);var jsTag=angular.module("jsTag");jsTag.factory("TagsInputService",["JSTag","JSTagsCollection",function(a,b){function c(a){this.options=a;var c=a.tags;if(c&&Object.getPrototypeOf(c)===b.prototype)this.tagsCollection=c;else{var d=a.defaultTags;this.tagsCollection=new b(d)}this.shouldBlurActiveTag=!0}return c.prototype.tagClicked=function(a){this.tagsCollection.setActiveTag(a)},c.prototype.tagDblClicked=function(a){var b=this.options.edit;b&&this.tagsCollection.setEditedTag(a)},c.prototype.onActiveTagKeydown=function(a,b){var c=this.tagsCollection.getActiveTag();if(null!==c){var d=b.$event,e=function(){this.shouldBlurActiveTag&&this.onActiveTagBlur(b)};switch(d.which){case 13:var f=this.options.edit;f&&(e.apply(this),this.tagsCollection.setEditedTag(c));break;case 8:this.tagsCollection.removeTag(c.id),a.isWaitingForInput=!0;break;case 37:e.apply(this);var g=this.tagsCollection.getPreviousTag(c);this.tagsCollection.setActiveTag(g);break;case 39:e.apply(this);var h=this.tagsCollection.getNextTag(c);h!==c?this.tagsCollection.setActiveTag(h):a.isWaitingForInput=!0}}},c.prototype.onActiveTagBlur=function(a){var b=this.tagsCollection.getActiveTag();null!==b&&this.tagsCollection.unsetActiveTag(b)},c.prototype.onEditTagBlur=function(a,b){a.unsetEditedTag(),this.isWaitingForInput=!0},c}]);var jsTag=angular.module("jsTag"),jsTag=angular.module("jsTag");jsTag.controller("JSTagMainCtrl",["$attrs","$scope","InputService","TagsInputService","jsTagDefaults",function(a,b,c,d,e){var f={};try{f=b.$eval(a.jsTagOptions)}catch(g){console.log("jsTag Error: Invalid user options, using defaults only")}var h=angular.copy(e);void 0!==f&&(f.texts=angular.extend(h.texts,f.texts||{}),angular.extend(h,f)),b.options=h,b.tagsInputService=new d(b.options),b.inputService=new c(b.options);var i=b.tagsInputService.tagsCollection;b.tagsCollection=i,b.$watch("tagsCollection._editedTag",function(a,c){b.isThereAnEditedTag=null!==a}),b.$watchCollection("tagsCollection._activeTags",function(a,c){b.isThereAnActiveTag=a.length>0})}]);var jsTag=angular.module("jsTag");jsTag.directive("jsTag",["$templateCache",function(a){return{restrict:"E",scope:!0,controller:"JSTagMainCtrl",templateUrl:function(a,b){var c=b.jsTagMode||"default";return"jsTag/source/templates/"+c+"/js-tag.html"}}}]),jsTag.directive("ngBlur",["$parse",function(a){return{restrict:"A",link:function(b,c,d){var e=a(d.ngBlur);c.bind("blur",function(a){b.$apply(function(){e(b,{$event:a})})})}}}]),jsTag.directive("focusMe",["$parse","$timeout",function(a,b){return{restrict:"A",link:function(c,d,e){var f=a(e.focusMe);c.$watch(f,function(a){a===!0&&b(function(){d[0].focus()})}),d.bind("blur",function(){c.$apply(f.assign(c,!1))})}}}]),jsTag.directive("focusOnce",["$timeout",function(a){return{restrict:"A",link:function(b,c,d){a(function(){c[0].select()})}}}]),jsTag.directive("autoGrow",["$timeout",function(a){return{link:function(b,c,d){var e=(c.css("paddingLeft"),c.css("paddingRight"),angular.element("<span></span>").css({position:"absolute",top:"-10000px",left:"-10000px",fontSize:c.css("fontSize"),fontFamily:c.css("fontFamily"),"white-space":"pre"}));c.after(e);var f=function(){var a=c.val().replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/&/g,"&amp;");""!==a?e.html(a):e.html(c[0].placeholder);var b=e[0].offsetWidth+10+"px";c.css("width",b)},g=c.attr("ng-model");g?b.$watch(g,f):c.bind("keyup keydown",f),a(f)}}}]),jsTag.directive("jsTagTypeahead",function(){return{restrict:"A",require:"?ngModel",link:function(a,b,c,d){b.bind("jsTag:breakcodeHit",function(b){a.$eval(c.options).editable!==!1&&$(b.currentTarget).typeahead("val","")})}}}),angular.module("jsTag").run(["$templateCache",function(a){a.put("jsTag/source/templates/default/js-tag.html",'<div\r\n  class="jt-editor"\r\n  ng-click="inputService.focusInput()" >\r\n  <span\r\n    ng-repeat="tag in tagsCollection.tags | toArray:orderBy:\'id\'"\r\n    ng-switch="tagsCollection.isTagEdited(tag)">\r\n    <span\r\n      ng-switch-when="false"\r\n      class="jt-tag active-{{tagsCollection.isTagActive(tag)}}">\r\n      <span\r\n        class="value"\r\n        ng-click="tagsInputService.tagClicked(tag)"\r\n        ng-dblclick="tagsInputService.tagDblClicked(tag)">\r\n        <span ng-if="options.valueTemplate" ng-include src="options.valueTemplate"></span>\r\n        <span ng-if="!options.valueTemplate">{{tag.value}}</span>\r\n      </span>\r\n      <span class="remove-button" ng-click="tagsCollection.removeTag(tag.id)">{{options.texts.removeSymbol}}</span>\r\n    </span>\r\n    <span\r\n      ng-switch-when="true">\r\n      <input\r\n        type="text"\r\n        class="jt-tag-edit"\r\n        focus-once\r\n        ng-model="tag.value"\r\n        data-tag-id="{{tag.id}}"\r\n        ng-keydown="inputService.tagInputKeydown(tagsCollection, {$event: $event})"\r\n        placeholder="{{options.texts.inputPlaceHolder}}"\r\n        auto-grow\r\n        />\r\n    </span>\r\n  </span>\r\n  <input\r\n    class="jt-tag-new"\r\n    type="text"\r\n    focus-me="inputService.isWaitingForInput"\r\n    ng-model="inputService.input"\r\n    ng-hide="isThereAnEditedTag"\r\n    ng-keydown="inputService.onKeydown(inputService, tagsCollection, {$event: $event})"\r\n    placeholder="{{options.texts.inputPlaceHolder}}"\r\n    ng-blur="inputService.onBlur(tagsCollection)"\r\n    auto-grow\r\n  />\r\n  <input\r\n    class="jt-fake-input"\r\n    focus-me="isThereAnActiveTag"\r\n    ng-keydown="tagsInputService.onActiveTagKeydown(inputService, {$event: $event})"\r\n    ng-blur="tagsInputService.onActiveTagBlur()" />\r\n</div>\r\n'),a.put("jsTag/source/templates/typeahead/js-tag.html",'<div\r\n  class="jt-editor"\r\n  ng-click="inputService.focusInput()" >\r\n  <span\r\n    ng-repeat="tag in tagsCollection.tags | toArray:orderBy:\'id\'"\r\n    ng-switch="tagsCollection.isTagEdited(tag)">\r\n    <span\r\n      ng-switch-when="false"\r\n      class="jt-tag active-{{tagsCollection.isTagActive(tag)}}">\r\n      <span\r\n        class="value"\r\n        ng-click="tagsInputService.tagClicked(tag)"\r\n        ng-dblclick="tagsInputService.tagDblClicked(tag)">\r\n        <span ng-if="options.valueTemplate" ng-include src="options.valueTemplate"></span>\r\n        <span ng-if="!options.valueTemplate">{{tag.value}}</span>\r\n      </span>\r\n      <span class="remove-button" ng-click="tagsCollection.removeTag(tag.id)">{{options.texts.removeSymbol}}</span>\r\n    </span>\r\n    <span\r\n      ng-switch-when="true">\r\n      <input\r\n        type="text"\r\n        class="jt-tag-edit"\r\n        focus-once\r\n        ng-model="tag.value"\r\n        data-tag-id="{{tag.id}}"\r\n        ng-keydown="inputService.tagInputKeydown(tagsCollection, {$event: $event})"\r\n        placeholder="{{options.texts.inputPlaceHolder}}"\r\n        auto-grow\r\n        options="exampleOptions" datasets="exampleData"\r\n        sf-typeahead\r\n        />\r\n    </span>\r\n  </span>\r\n  <input\r\n    class="jt-tag-new"\r\n    type="text"\r\n    focus-me="inputService.isWaitingForInput"\r\n    ng-model="inputService.input"\r\n    ng-hide="isThereAnEditedTag"\r\n    ng-keydown="inputService.onKeydown(inputService, tagsCollection, {$event: $event})"\r\n    ng-blur="inputService.onBlur(tagsCollection)"\r\n    placeholder="{{options.texts.inputPlaceHolder}}"\r\n    auto-grow\r\n    options="exampleOptions" datasets="exampleData"\r\n    sf-typeahead\r\n    js-tag-typeahead\r\n  />\r\n  <input\r\n    class="jt-fake-input"\r\n    focus-me="isThereAnActiveTag"\r\n    ng-keydown="tagsInputService.onActiveTagKeydown(inputService, {$event: $event})"\r\n    ng-blur="tagsInputService.onActiveTagBlur()" />\r\n</div>\r\n')}]);